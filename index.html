<!doctype html>
<html lang="en" dir="ltr" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Huizemark • Smart Match</title>

  <!-- Set theme BEFORE styles to prevent flash -->
  <script>
    (function(){
      try {
        var saved = localStorage.getItem('sm-theme'); // 'dark' | 'light' | null
        var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        var theme = saved || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      } catch(e){}
    })();
  </script>

  <style>
    /* ============== THEME TOKENS ============== */
    :root{
      --hz-orange:#f58220; --hz-grey:#4d4d4d;
      --focus:#1d4ed8;
      /* Defaults (light) to avoid unstyled flash if JS disabled */
      --bg:#ffffff; --text:#222; --muted:#6b7280; --border:#e5e7eb; --card:#ffffff;
    }
    :root[data-theme="light"]{
      --bg:#ffffff; --text:#222; --muted:#6b7280; --border:#e5e7eb; --card:#ffffff;
    }
    :root[data-theme="dark"]{
      --bg:#0b0b0c; --text:#eaeaea; --muted:#9aa0a6; --border:#2a2a2d; --card:#141416;
    }

    /* ============== BASE & LAYOUT ============== */
    html:focus-within{ scroll-behavior:smooth; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width: 820px; margin: 24px auto; padding: 16px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand__logo{ height:64px; }
    .toolbar{ margin-left:auto; display:flex; align-items:center; gap:10px; }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; margin-top:16px; }

    .skip-link{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
    .skip-link:focus{ left:8px; top:8px; width:auto; height:auto; padding:10px 12px; background:#111; color:#fff; border-radius:8px; z-index:9999; }

    /* ============== FORMS ============== */
    label{ display:block; margin:10px 0 6px; font-weight:600; }
    input,select,button,textarea{ font:inherit; }
    input,select,textarea{
      width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--text);
    }
    input:focus,select:focus,button:focus,a:focus,textarea:focus{ outline:3px solid var(--focus); outline-offset:2px; }

    .row{ display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }

    /* ============== BUTTONS ============== */
    .btn{ background:var(--hz-orange); color:#fff; border:0; border-radius:10px; padding:12px 16px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .btn.secondary{ background:var(--hz-grey); }
    .btn.ghost{ background:transparent; color:var(--text); border:1px solid var(--border); }

    /* ============== TEXT ============== */
    a{ color:var(--hz-orange); }
    .muted{ color:var(--muted); font-size:.95rem; }
    .results ol{ padding-left:1.2rem; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
    .pill{ display:inline-block; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; margin:3px 6px 0 0; }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <header class="wrap" role="banner">
    <div class="brand" aria-label="Huizemark Smart Match header">
      <img class="brand__logo" src="https://d21tw07c6rnmp0.cloudfront.net/media/uploads/94/theme-settings/2025/5/94_8a5e0d54687d41228f79c92853b42629.png" alt="Huizemark logo" loading="lazy" decoding="async" />
      <h1 style="margin:0">Smart Match</h1>
      <div class="toolbar" role="group" aria-label="Theme toggle">
        <button id="toggleTheme" class="btn secondary" type="button" aria-pressed="false" aria-label="Toggle dark mode">🌙 Dark mode</button>
      </div>
    </div>
  </header>

  <main id="main" class="wrap" role="main">
    <!-- Intro -->
    <section class="card" aria-labelledby="intro-title">
      <h2 id="intro-title" style="margin-top:0">Find 2–3 Huizemark properties fast</h2>
      <p class="muted">We respect your privacy. We’ll ask consent first. All matches link to Blessing’s page.</p>
    </section>

    <!-- Consent -->
    <section class="card" aria-labelledby="consent-title">
      <h2 id="consent-title" style="margin-top:0">Consent</h2>
      <p class="muted">
        By continuing, you consent to Huizemark storing your details for property matching only.
        Type <strong>STOP</strong> any time to opt out.
      </p>
    </section>

    <!-- Preferences -->
    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title" style="margin-top:0">Your preferences</h2>
      <form id="qform" aria-describedby="form-help" novalidate>
        <p id="form-help" class="sr-only">Answer the following fields, then press the Show Matches button.</p>
        <div class="row">
          <div>
            <label for="budget">Max budget (R)</label>
            <input id="budget" name="budget" inputmode="numeric" autocomplete="off" required placeholder="e.g. 1200000" aria-required="true" />
          </div>
          <div>
            <label for="beds">Bedrooms</label>
            <select id="beds" name="beds" aria-label="Number of bedrooms">
              <option>2</option><option selected>3</option><option>4</option><option>5+</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="schools">Schools</label>
            <select id="schools" name="schools" aria-label="Proximity to schools">
              <option>Walk</option><option selected>Short drive</option><option>Not important</option>
            </select>
          </div>
          <div>
            <label for="garden">Garden</label>
            <select id="garden" name="garden" aria-label="Garden preference">
              <option selected>Sunny</option><option>Shaded</option><option>Doesn’t matter</option>
            </select>
          </div>
        </div>
        <div>
          <label for="approved">Bond pre-approved?</label>
          <select id="approved" name="approved" aria-label="Bond pre-approval">
            <option>Yes</option><option selected>No</option>
          </select>
        </div>

        <div role="group" aria-label="Actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" type="submit">Show Matches</button>
          <button id="toggleOverBudget" class="btn ghost" type="button" aria-pressed="false" title="Include slightly-over-budget homes (≤10%)">Allow +10% budget</button>
          <a id="whatsappTop" class="btn" href="https://wa.me/27821234567?text=Hi%20Blessing,%20please%20match%20me" target="_blank" rel="noopener" role="button" aria-label="Chat with Blessing on WhatsApp">WhatsApp Blessing</a>
          <a id="emailTop" class="btn secondary" href="mailto:blessing@huizemark.co.za?subject=Smart%20Match%20Lead" role="button" aria-label="Email Blessing">Email Blessing</a>
        </div>
      </form>
    </section>

    <!-- Results -->
    <section class="card results" aria-labelledby="results-title">
      <h2 id="results-title" style="margin-top:0">Top Matches</h2>
      <div id="out" aria-live="polite" aria-atomic="false">
        <p class="muted">Complete the form to see suggested properties.</p>
      </div>
      <div id="summaryBlock" class="muted" style="white-space:pre-wrap; margin-top:10px; display:none;"></div>
    </section>

    <!-- Lead capture -->
    <section class="card" aria-labelledby="lead-title">
      <h2 id="lead-title" style="margin-top:0">Send to Blessing</h2>
      <form id="lead" style="display:none" novalidate>
        <div class="row">
          <div>
            <label for="name">Your name</label>
            <input id="name" name="name" autocomplete="name" required aria-required="true" />
          </div>
          <div>
            <label for="email">Your email</label>
            <input id="email" name="email" type="email" autocomplete="email" required aria-required="true" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="phone">Your phone (WhatsApp)</label>
            <input id="phone" name="phone" inputmode="tel" autocomplete="tel" required aria-required="true" />
          </div>
          <div>
            <label for="consent">Consent</label>
            <select id="consent" name="consent" aria-label="Consent to store details" required>
              <option value="YES" selected>YES (store for matching)</option>
              <option>NO</option>
            </select>
          </div>
        </div>

        <div role="group" aria-label="Contact actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <a id="wa" class="btn" target="_blank" rel="noopener" role="button" aria-label="Chat with Blessing on WhatsApp">Chat on WhatsApp</a>
          <a id="mailto" class="btn secondary" role="button" aria-label="Email Blessing">Email Blessing</a>
          <button id="submitLead" class="btn" type="submit">Send details</button>
        </div>

        <p id="status" class="muted" role="status" aria-live="polite" style="margin-top:8px"></p>
      </form>
      <p class="muted" style="margin-top:12px">All results link back to
        <a href="https://www.huizemark.com/agents/blessing-nsibande/75570/" target="_blank" rel="noopener">Blessing’s profile</a>.
      </p>
    </section>
  </main>

  <footer class="wrap" role="contentinfo" style="margin-bottom:24px;">
    <div class="card" aria-label="Quick contact">
      <div style="display:flex; flex-wrap:wrap; gap:10px;">
        <a class="btn" href="https://wa.me/27821234567?text=Hi%20Blessing,%20please%20match%20me" target="_blank" rel="noopener">WhatsApp Blessing</a>
        <a class="btn secondary" href="mailto:blessing@huizemark.co.za?subject=Smart%20Match%20Lead">Email Blessing</a>
      </div>
    </div>
  </footer>

  <script>
    /* ===================== DARK/LIGHT TOGGLE (persisted) ===================== */
    (function(){
      const btn = document.getElementById('toggleTheme');
      const root = document.documentElement;

      function updateBtn(){
        const isDark = root.getAttribute('data-theme') === 'dark';
        btn.setAttribute('aria-pressed', String(isDark));
        btn.textContent = isDark ? '☀️ Light mode' : '🌙 Dark mode';
      }
      updateBtn();

      btn.addEventListener('click', ()=>{
        const current = root.getAttribute('data-theme') || 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
        try { localStorage.setItem('sm-theme', next); } catch(e){}
        updateBtn();
      });

      btn.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); btn.click(); }});
    })();

    /* ===================== DATA & MATCHING ===================== */
    async function loadStock(){
      try{
        const res = await fetch('data/listings.json', {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        return Array.isArray(data) ? data : [];
      }catch(e){
        console.warn('Failed to load listings.json', e);
        return [];
      }
    }

    function scoreLead(ans, x){
      let s=0;
      if((+ans.beds.replace(/\D/g,'')||2) <= (x.beds||0)) s+=10;
      if(ans.schools) s += 10;
      if(ans.garden) s += 5;
      if(String(ans.approved).toLowerCase()==='yes') s+=60;
      return s;
    }

    function withinBudget(price, budget, allowOver10){
      if(!budget) return true;
      const b = parseInt(String(budget).replace(/\D/g,''),10)||0;
      if(price<=b) return true;
      if(allowOver10 && price <= Math.round(b*1.10)) return true;
      return false;
    }

    function cleanTitle(title){
      return (title||'').replace(/\b\d+\s*bed(?:room)?s?\b/i,'').replace(/\s{2,}/g,' ').trim();
    }

    function buildSummary(ans, matches){
      const header = [
        "Hi Blessing, please see my Smart Match results:",
        `Budget: R${ans.budget}`,
        `Beds wanted: ${ans.beds}`,
        `Schools: ${ans.schools}`,
        `Garden: ${ans.garden}`,
        `Pre-approved: ${ans.approved}`,
        "",
        "Matches:"
      ].join("\n");

      const items = matches.map(m => {
        const x = m.x;
        return [
          `• ${x.title}`,
          `  WebRef: ${x.ref}`,
          `  Price: R${(x.price||0).toLocaleString('en-ZA')}`,
          `  Beds: ${x.beds}`,
          `  Area: ${x.area}`,
          `  Link: ${x.url}`
        ].join("\n");
      });

      return header + "\n\n" + items.join("\n\n");
    }

    function renderPills(matches){
      return matches.map(m=>{
        const x=m.x;
        return `<span class="pill">${x.area}</span><span class="pill">R${(x.price||0).toLocaleString('en-ZA')}</span><span class="pill">${x.beds} bed</span>`;
      }).join(' ');
    }

    const qform = document.getElementById('qform');
    const out   = document.getElementById('out');
    const lead  = document.getElementById('lead');
    const statusEl = document.getElementById('status');
    const waBtn = document.getElementById('wa');
    const mailBtn = document.getElementById('mailto');
    const whatsappTop = document.getElementById('whatsappTop');
    const emailTop = document.getElementById('emailTop');
    const summaryBlock = document.getElementById('summaryBlock');
    const toggleOverBudgetBtn = document.getElementById('toggleOverBudget');

    let allowOver10 = false;
    toggleOverBudgetBtn.addEventListener('click', ()=>{
      allowOver10 = !allowOver10;
      toggleOverBudgetBtn.setAttribute('aria-pressed', String(allowOver10));
      toggleOverBudgetBtn.textContent = allowOver10 ? 'Limit to budget' : 'Allow +10% budget';
      if(qform.dataset.lastAns){
        const ans = JSON.parse(qform.dataset.lastAns);
        runMatch(ans);
      }
    });

    let STOCK = [];
    loadStock().then(d=>{ STOCK=d; });

    qform.addEventListener('submit', (e)=>{
      e.preventDefault();
      const ans = Object.fromEntries(new FormData(qform).entries());
      qform.dataset.lastAns = JSON.stringify(ans);
      runMatch(ans);
    });

    function runMatch(ans){
      const budget = parseInt(String(ans.budget||'').replace(/\D/g,''),10)||0;
      const candidates = STOCK.filter(x => withinBudget(x.price||0, budget, allowOver10));

      const ranked = candidates.map(x=>({x, score: scoreLead(ans,x)}))
        .sort((a,b)=> b.score - a.score || (a.x.price||0)-(b.x.price||0))
        .slice(0,3);

      if(ranked.length===0 && !allowOver10){
        out.innerHTML = `<p>No matches within budget. You can <strong>Allow +10% budget</strong> above to see close-fit homes.</p>`;
        summaryBlock.style.display='none';
        lead.style.display='none';
        return;
      }
      if(ranked.length===0 && allowOver10){
        out.innerHTML = `<p>No matches found. Try adjusting your preferences.</p>`;
        summaryBlock.style.display='none';
        lead.style.display='none';
        return;
      }

      const listHtml = ranked.map(m=>{
        const x=m.x;
        return `<li>
          <a href="${x.url}" target="_blank" rel="noopener">${cleanTitle(x.title)}</a>
          <div class="muted">WebRef ${x.ref} • R${(x.price||0).toLocaleString('en-ZA')} • ${x.beds} bed • ${x.area}</div>
        </li>`;
      }).join("");

      const hot = Math.max(...ranked.map(m=>m.score))>=80;
      out.innerHTML = `
        <div style="margin-bottom:8px">${renderPills(ranked)}</div>
        <ol>${listHtml}</ol>
        ${hot
          ? '<p><strong>Hot lead:</strong> Would you like a viewing? Choose a time and we’ll confirm with Blessing.</p>'
          : '<p class="muted">Tip: Not pre-approved? We can connect you to a bond originator for a quick check.</p>'}
      `;

      const summary = buildSummary(ans, ranked);
      summaryBlock.textContent = summary;
      summaryBlock.style.display = 'block';

      const waText = encodeURIComponent(summary);
      const subject = encodeURIComponent('Smart Match Lead');
      const body = encodeURIComponent(summary);

      whatsappTop.href = `https://wa.me/27821234567?text=${waText}`;
      emailTop.href    = `mailto:blessing@huizemark.co.za?subject=${subject}&body=${body}`;

      waBtn.href   = `https://wa.me/27821234567?text=${waText}`;
      mailBtn.href = `mailto:blessing@huizemark.co.za?subject=${subject}&body=${body}`;

      lead.style.display = 'block';
      lead.setAttribute('tabindex','-1');
      lead.focus();
      statusEl.textContent = "";
    }

    lead.addEventListener('submit', (e)=>{
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(lead).entries());
      if(String(formData.consent).toUpperCase()!=='YES'){
        statusEl.textContent = "We need consent to send your details.";
        return;
      }
      const base = summaryBlock.textContent || '';
      const full = `${base}\n\nNAME: ${formData.name}\nPHONE: ${formData.phone}`;
      const waText = encodeURIComponent(full);
      const subject = encodeURIComponent('Smart Match Lead');
      const body = encodeURIComponent(full);
      waBtn.href   = `https://wa.me/27821234567?text=${waText}`;
      mailBtn.href = `mailto:blessing@huizemark.co.za?subject=${subject}&body=${body}`;
      statusEl.textContent = "Thanks! Use the buttons above to contact Blessing.";
      // window.location.href = waBtn.href; // optional auto-open
    });

    for(const el of [whatsappTop, emailTop]){
      el.setAttribute('tabindex','0');
      el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); el.click(); }});
    }
  </script>
</body>
</html>
