<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Huizemark • Smart Match (Blessing Nsibande)</title>

  <!-- 🧸 SIMPLE NOTES (maintenance):
       - This file is ONE page that does buyers + sellers.
       - Results come from /data/listings.json (GitHub Action updates nightly).
       - Change agent phone/email below in the CONFIG section.
       - Dark mode is manual (button). We removed "auto dark" to avoid confusion.
       - We only show matches when user is verified (email + SA phone + code).
       - WhatsApp/Email buttons include the full summary once verified. -->

  <!-- Favicon -->
  <link rel="icon" type="image/png"
        href="https://d21tw07c6rnmp0.cloudfront.net/media/uploads/94/theme-settings/2025/5/94_8a5e0d54687d41228f79c92853b42629.png">
  <link rel="apple-touch-icon"
        href="https://d21tw07c6rnmp0.cloudfront.net/media/uploads/94/theme-settings/2025/5/94_8a5e0d54687d41228f79c92853b42629.png" />

  <!-- Best-effort client hardening (static hosting) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://api.whatsapp.com https://d21tw07c6rnmp0.cloudfront.net; img-src 'self' data: https://d21tw07c6rnmp0.cloudfront.net; style-src 'self' 'unsafe-inline'; script-src 'self'; connect-src 'self'; frame-ancestors 'none'">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta name="format-detection" content="telephone=no">

  <style>
    /* 🎨 BRAND THEME TOKENS (only manual toggle, no auto-dark to avoid conflicts) */
    :root{
      --hz-orange:#f58220; --hz-grey:#4d4d4d; --hz-bg:#ffffff; --hz-text:#222;
      --hz-muted:#6b7280; --hz-border:#e5e7eb; --btn-text:#fff; --card-bg:#ffffff;
      color-scheme: light;
    }
    .theme-dark{
      --hz-bg:#0b0b0c; --hz-text:#eaeaea; --hz-muted:#9aa0a6; --hz-border:#2a2a2d; --card-bg:#141416;
      color-scheme: dark;
    }

    /* 🧱 LAYOUT + BASICS */
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:var(--hz-bg);color:var(--hz-text)}
    a{color:var(--hz-orange)}
    .wrap{max-width:780px;margin:24px auto;padding:0 16px}
    .card{background:var(--card-bg);border:1px solid var(--hz-border);border-radius:12px;padding:20px;margin-top:16px}
    .brand{display:flex;align-items:center;gap:12px}.brand img{height:64px}
    .toolbar{margin-left:auto}
    label{display:block;margin:10px 0 4px;font-weight:600}
    input,select,button,textarea{font:inherit}
    input,select,textarea{width:100%;padding:12px;border:1px solid var(--hz-border);border-radius:10px;background:transparent;color:var(--hz-text)}
    /* Dark inputs/dropdowns are truly dark */
    .theme-dark input,.theme-dark select,.theme-dark textarea{background:#0f0f10;color:#eaeaea;border-color:#2a2a2d}
    .theme-dark select option{background:#0f0f10;color:#eaeaea}

    .btn{background:var(--hz-orange);color:var(--btn-text);border:0;border-radius:10px;padding:12px 16px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
    .btn.secondary{background:#4d4d4d}
    .btn[aria-disabled="true"]{opacity:0.5;pointer-events:none}
    .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media(max-width:640px){.row{grid-template-columns:1fr}}
    .muted{color:var(--hz-muted)}
    .results ol{padding-left:1.2rem}
    .pill{display:inline-block;background:#f8f8f8;border:1px solid var(--hz-border);border-radius:999px;padding:4px 8px;font-size:12px;margin-left:8px}
    .theme-dark .pill{background:#121214}
    .hidden{display:none}

    /* Light deterrents for copying */
    .results { position: relative; user-select: none; }
    .results .wm {
      position:absolute; inset:0; pointer-events:none;
      background-image: repeating-linear-gradient(
        -30deg,
        rgba(245,130,32,0.08) 0px,
        rgba(245,130,32,0.08) 2px,
        transparent 2px,
        transparent 140px
      );
      mix-blend-mode: multiply;
    }
    .theme-dark .results .wm { mix-blend-mode: screen; }
    .no-select { user-select: none; }
  </style>
</head>
<body>
  <header class="wrap">
    <div class="brand">
      <img src="https://d21tw07c6rnmp0.cloudfront.net/media/uploads/94/theme-settings/2025/5/94_8a5e0d54687d41228f79c92853b42629.png" alt="Huizemark" />
      <h1 style="margin:0">Smart Match</h1>
      <div class="toolbar">
        <button id="toggleTheme" class="btn secondary" type="button" aria-pressed="false">🌙 Dark mode</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Role -->
    <section class="card" aria-labelledby="role-title">
      <h2 id="role-title" style="margin-top:0">How can we help?</h2>
      <div role="radiogroup" aria-label="Select your goal" style="display:flex; gap:12px; flex-wrap:wrap">
        <label><input type="radio" name="role" id="roleBuyer" value="buyer" checked> I’m buying</label>
        <label><input type="radio" name="role" id="roleSeller" value="seller"> I’m selling</label>
      </div>
      <p class="muted" style="margin:8px 0 0">Choose one. We’ll show the right steps.</p>
    </section>

    <!-- Buyer: preferences -->
    <section id="buyerPrefs" class="card">
      <h2 style="margin-top:0">Your preferences</h2>
      <form id="qform" novalidate>
        <div class="row">
          <div>
            <label for="budget">Max budget (R)</label>
            <input id="budget" name="budget" inputmode="numeric" required placeholder="e.g. 1200000" />
          </div>
          <div>
            <label for="beds">Bedrooms</label>
            <select id="beds" name="beds">
              <option>2</option><option selected>3</option><option>4</option><option>5+</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="approved">Bond pre-approved?</label>
            <select id="approved" name="approved"><option>Yes</option><option selected>No</option></select>
          </div>
          <div>
            <label for="count">How many matches?</label>
            <select id="count" name="count"><option>1</option><option selected>3</option><option>5</option><option>10</option></select>
            <div style="margin-top:6px">
              <label><input type="checkbox" id="allowOverBudget"> Include a few slightly above budget (≤ 8%)</label>
            </div>
          </div>
        </div>

        <!-- Honeypot -->
        <div style="position:absolute; left:-9999px; top:-9999px;">
          <label>Leave this field empty</label>
          <input id="hp" name="hp" tabindex="-1" autocomplete="off">
        </div>

        <button class="btn" type="submit">Show Matches</button>
      </form>
    </section>

    <!-- Buyer: results -->
    <section id="buyerResults" class="card results">
      <h2 style="margin-top:0">Top Matches</h2>
      <div id="out" class="muted">Complete the form to see suggested properties.</div>
      <div class="wm" aria-hidden="true"></div>
    </section>

    <!-- Seller: form -->
    <section id="sellerCard" class="card hidden" aria-labelledby="seller-title">
      <h2 id="seller-title" style="margin-top:0">Tell us about your property</h2>

      <div class="row">
        <div>
          <label for="s_address">Street address</label>
          <input id="s_address" placeholder="e.g. 21 Trollip Road">
        </div>
        <div>
          <label for="s_suburb">Suburb / Town</label>
          <input id="s_suburb" placeholder="e.g. Brenthurst, Brakpan">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="s_type">Property type</label>
          <select id="s_type">
            <option>House</option><option>Apartment</option><option>Townhouse</option>
            <option>Vacant land</option><option>Commercial</option>
          </select>
        </div>
        <div>
          <label for="s_beds">Bedrooms</label>
          <select id="s_beds">
            <option>N/A</option><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5+</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="s_baths">Bathrooms</label>
          <select id="s_baths">
            <option>N/A</option><option>1</option><option selected>2</option><option>3</option><option>4+</option>
          </select>
        </div>
        <div>
          <label for="s_sizes">Erf / Floor size</label>
          <input id="s_sizes" placeholder="e.g. Erf 500m², Floor 180m²">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="s_upgrades">Upgrades / features</label>
          <input id="s_upgrades" placeholder="e.g. New kitchen 2023, solar, flatlet">
        </div>
        <div>
          <label for="s_price">Target sale price (R)</label>
          <input id="s_price" inputmode="numeric" placeholder="e.g. 1450000">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="s_timeline">When do you want to sell?</label>
          <select id="s_timeline">
            <option selected>As soon as possible</option>
            <option>Within 30 days</option>
            <option>1–3 months</option>
            <option>3+ months</option>
          </select>
        </div>
        <div>
          <label for="s_links">Photos / video links (optional)</label>
          <input id="s_links" placeholder="e.g. Google Drive, Dropbox, YouTube">
        </div>
      </div>

      <!-- Honeypot (seller) -->
      <div style="position:absolute; left:-9999px; top:-9999px;">
        <label>Leave this field empty</label>
        <input id="hp2" name="hp2" tabindex="-1" autocomplete="off">
      </div>

      <p class="muted">We’ll verify your contact details below, then you can message Blessing instantly.</p>
    </section>

    <!-- Shared: verification + send -->
    <section id="verifyCard" class="card hidden" aria-live="polite">
      <h2 style="margin-top:0">Contact & verification <span class="pill">Required</span></h2>

      <div class="row">
        <div><label for="name">Your name</label><input id="name" autocomplete="name" placeholder="e.g. Thabo M."></div>
        <div>
          <label for="email">Your email</label>
          <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />
          <div id="emailErr" class="muted" style="color:#b91c1c" hidden>Enter a valid email address.</div>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label for="phone">Your phone (WhatsApp)</label>
          <input id="phone" inputmode="tel" autocomplete="tel" placeholder="082 123 4567 or +27 82 123 4567" />
          <div id="phoneErr" class="muted" style="color:#b91c1c" hidden>Enter a valid SA mobile number (e.g. 082… / +27 82…).</div>
        </div>
        <div>
          <label for="cta">What next?</label>
          <select id="cta">
            <option selected>Arrange a viewing</option>
            <option>Request more photos/videos</option>
            <option>Get bond pre-approval help</option>
            <option>Call me back</option>
            <option>Free valuation (seller)</option>
            <option>Book listing appointment (seller)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label for="chk">Type this code to prove you’re real</label>
          <div style="display:flex;gap:8px;align-items:center">
            <code id="code" style="font-weight:700; font-size:1.05rem">SM-000000</code>
            <button id="regen" type="button" class="btn secondary" style="padding:8px 12px">↻ New code</button>
          </div>
          <input id="chk" placeholder="Type the code above exactly" aria-describedby="veriMsg" />
          <div id="veriMsg" class="muted" style="margin-top:4px" hidden>Code does not match.</div>
        </div>
        <div style="display:flex;align-items:center">
          <label><input type="checkbox" id="consent"> I consent to Huizemark storing my details (POPIA)</label>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <a id="btnWA"   class="btn"           target="_blank" rel="noopener" aria-disabled="true">WhatsApp Blessing</a>
        <a id="btnMail" class="btn secondary"                     aria-disabled="true">Email Blessing</a>
      </div>
      <p class="muted" id="helper" style="margin:6px 0 0">Fill details, pass verification, then buttons will unlock.</p>

      <p class="muted" style="margin:12px 0 0">
        View all of Blessing’s listings:
        <a href="https://www.huizemark.com/agents/blessing-nsibande/75570/" target="_blank" rel="noopener">
          Blessing Nsibande • Huizemark
        </a>
      </p>
    </section>
  </main>

  <footer class="wrap">
    <div class="card">
      <p class="muted" style="margin:0">
        View all of Blessing’s Huizemark listings:
        <a href="https://www.huizemark.com/agents/blessing-nsibande/75570/" target="_blank" rel="noopener">
          Blessing Nsibande • Huizemark
        </a>
      </p>
    </div>
  </footer>

  <script>
    /* ======================
       CONFIG (change me)
       ====================== */
    const AGENT_PHONE_E164 = '27662729016';          // WhatsApp (no '+')
    const AGENT_EMAIL      = 'blessing@huizemark.co.za';
    const STOCK_URL        = '/data/listings.json';  // nightly-updated file

    /* ======================
       THEME (manual toggle)
       ====================== */
    (function(){
      const root = document.documentElement;
      const btn  = document.getElementById('toggleTheme');
      const saved = localStorage.getItem('sm-theme');
      if(saved==='dark') root.classList.add('theme-dark');
      const syncLabel = () => {
        const dark = root.classList.contains('theme-dark');
        btn.textContent = dark ? '☀️ Light mode' : '🌙 Dark mode';
        btn.setAttribute('aria-pressed', String(dark));
      };
      syncLabel();
      btn.addEventListener('click', ()=>{
        root.classList.toggle('theme-dark');
        localStorage.setItem('sm-theme', root.classList.contains('theme-dark')?'dark':'light');
        syncLabel();
      });
    })();

    /* ======================
       DETER casual copy/inspect/print (not bulletproof; allow inputs)
       ====================== */
    document.addEventListener('contextmenu', e => {
      const t = e.target;
      if (t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable)) return;
      e.preventDefault();
    });
    document.addEventListener('keydown', e => {
      const ctrl = e.ctrlKey || e.metaKey;
      const inField = ['INPUT','TEXTAREA','SELECT'].includes((e.target||{}).tagName);
      if (!inField) {
        const k = e.key.toLowerCase();
        if ( (ctrl && (k==='s' || k==='u' || k==='p')) || e.key==='F12' || (ctrl && e.shiftKey && k==='i') ) {
          e.preventDefault();
          e.stopPropagation();
        }
      }
    });

    /* ======================
       HELPERS
       ====================== */
    const $ = sel => document.querySelector(sel);
    function fmtRand(n){ return 'R' + Number(n||0).toLocaleString('en-ZA'); }
    function bedsLbl(v){ return (v==null? 'N/A' : String(v)); }
    function numeric(v){ return parseInt(String(v||'').replace(/\D/g,'' )||'0',10); }
    function join2(arr){ return arr.filter(Boolean).join('\n\n'); }

    function normaliseSAMobile(input){
      if(!input) return null;
      const digits = String(input).replace(/\D/g,'');
      if(digits.startsWith('27') && digits.length===11) return digits;      // 27XXXXXXXXX
      if(digits.startsWith('0')  && digits.length===10) return '27'+digits.slice(1);
      return null;
    }
    function validateEmail(e){
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(String(e||'').trim());
    }
    async function loadStock(){
      try{
        const r = await fetch(STOCK_URL,{cache:'no-store'});
        if(!r.ok) throw 0;
        return await r.json();
      }catch(_){ return []; }
    }

    /* ======================
       MATCHING
       ====================== */
    function scoreLead(ans,x){
      let s=0;
      if(numeric(ans.budget) >= (x.price||Infinity)) s+=15;
      const want = parseInt(String(ans.beds||'2').replace('+','')||'2',10);
      if(want <= (x.beds||0)) s+=10;
      if(String(ans.approved).toLowerCase()==='yes') s+=60;
      return s;
    }
    function sortStrictByCloseness(budget){
      return (a,b)=>{
        const da = budget - (a.x.price||0), db = budget - (b.x.price||0);
        if(da!==db) return da-db;
        if((b.x.price||0)!==(a.x.price||0)) return (b.x.price||0)-(a.x.price||0); // higher first
        return b.score-a.score;
      };
    }
    function sortNearByCloseness(budget){
      return (a,b)=>{
        const da = (a.x.price||Infinity)-budget, db = (b.x.price||Infinity)-budget;
        if(da!==db) return da-db;
        if((b.x.price||0)!==(a.x.price||0)) return (b.x.price||0)-(a.x.price||0);
        return b.score-a.score;
      };
    }

    /* ======================
       MESSAGE BUILDERS
       ====================== */
    let baseSummary = ''; // buyer prefs+matches
    let fullSummary = ''; // +PII/CTA when consented

    function buildBuyerBaseSummary(ans, chosen){
      const budgetNum = numeric(ans.budget);
      const blocks = chosen.map(m => [
        `• ${m.x.title}`,
        `  WebRef: ${m.x.ref||'—'}`,
        `  Price: ${fmtRand(m.x.price)}`,
        `  Beds: ${bedsLbl(m.x.beds)}`,
        `  Area: ${m.x.area||''}`,
        `  Link: ${m.x.url}`
      ].join('\n'));
      baseSummary = join2([
        `Lead Type: BUYER`,
        `Hi Blessing, please see my Smart Match results:`,
        `Budget: ${fmtRand(budgetNum)}`,
        `Beds wanted: ${ans.beds}`,
        `Pre-approved: ${ans.approved}`,
        ``,
        `Matches:`,
        ...blocks
      ]);
    }
    function buildBuyerFullSummary(){
      const parts = [baseSummary, '---'];
      if($('#consent').checked){
        const nm = $('#name').value.trim(), em = $('#email').value.trim(), ph = $('#phone').value.trim();
        if(nm || em || ph){ parts.push('BUYER DETAILS'); }
        if(nm) parts.push(`Name: ${nm}`);
        if(em) parts.push(`Email: ${em}`);
        if(ph) parts.push(`Phone: ${ph}`);
      }
      const cta = $('#cta').value;
      parts.push(`Next step: ${cta}`);
      fullSummary = join2(parts);
      return fullSummary || baseSummary;
    }
    function buildSellerSummary(){
      const p = {
        addr:  $('#s_address').value.trim(),
        sub:   $('#s_suburb').value.trim(),
        type:  $('#s_type').value,
        beds:  $('#s_beds').value,
        baths: $('#s_baths').value,
        sizes: $('#s_sizes').value.trim(),
        upg:   $('#s_upgrades').value.trim(),
        price: $('#s_price').value.trim(),
        tl:    $('#s_timeline').value,
        links: $('#s_links').value.trim(),
      };
      const parts = [
        'Lead Type: SELLER',
        'Hi Blessing, I want to list my property with Huizemark.',
        `Address: ${p.addr || '—'}`,
        `Suburb: ${p.sub || '—'}`,
        `Type: ${p.type}`,
        `Beds/Baths: ${p.beds} / ${p.baths}`,
        `Sizes: ${p.sizes || '—'}`,
        `Upgrades: ${p.upg || '—'}`,
        `Target price: ${p.price ? 'R' + Number(p.price.replace(/\D/g,'')||0).toLocaleString('en-ZA') : '—'}`,
        `Timeline: ${p.tl}`,
        p.links ? `Links: ${p.links}` : null,
        '---'
      ].filter(Boolean);
      if($('#consent').checked){
        const nm = $('#name').value.trim(), em = $('#email').value.trim(), ph = $('#phone').value.trim();
        if(nm || em || ph){ parts.push('OWNER DETAILS'); }
        if(nm) parts.push(`Name: ${nm}`);
        if(em) parts.push(`Email: ${em}`);
        if(ph) parts.push(`Phone: ${ph}`);
      }
      const cta = $('#cta').value;
      parts.push(`Next step: ${cta}`);
      return parts.join('\n');
    }

    /* ======================
       VERIFICATION
       ====================== */
    let challenge = 'SM-000000';
    function newCode(){
      const n = Math.floor(Math.random()*900000)+100000;
      challenge = 'SM-' + n;
      $('#code').textContent = challenge;
      $('#chk').value = '';
      setVeriMessage('');
    }
    function setVeriMessage(msg, ok=false){
      const el = $('#veriMsg');
      if(!msg){ el.hidden = true; el.textContent=''; return; }
      el.hidden = false;
      el.textContent = msg;
      el.style.color = ok ? '#15803d' : '#b91c1c';
    }
    function setEmailError(show){ $('#emailErr').hidden = !show; }
    function setPhoneError(show){ $('#phoneErr').hidden = !show; }
    function isVerified(){
      const emailOK = validateEmail($('#email').value.trim());
      setEmailError(!emailOK);
      const phoneE164 = normaliseSAMobile($('#phone').value.trim());
      const phoneOK = !!phoneE164;
      setPhoneError(!phoneOK);
      const codeOK = $('#chk').value.trim().toUpperCase() === challenge.toUpperCase();
      setVeriMessage(codeOK ? 'Verified ✓' : ($('#chk').value ? 'Code does not match.' : ''), codeOK);
      return emailOK && phoneOK && codeOK;
    }
    function toggleSendButtons(enabled){
      $('#btnWA').setAttribute('aria-disabled', enabled ? 'false' : 'true');
      $('#btnMail').setAttribute('aria-disabled', enabled ? 'false' : 'true');
    }
    function currentMessageText(){
      if($('#roleSeller').checked){
        return buildSellerSummary();
      } else {
        return buildBuyerFullSummary();
      }
    }
    function updateAnchors(){
      const text = encodeURIComponent(currentMessageText());
      $('#btnWA').href   = `https://api.whatsapp.com/send?phone=${AGENT_PHONE_E164}&text=${text}`;
      $('#btnMail').href = `mailto:${AGENT_EMAIL}?subject=${encodeURIComponent('Smart Match Lead')}&body=${text}`;
    }

    /* ======================
       COMPUTE & RENDER MATCHES
       ====================== */
    function computeAndRenderMatches(STOCK, ans){
      const wantCount = Math.max(1, parseInt(ans.count||'3',10));
      const allowOver = !!document.getElementById('allowOverBudget').checked;
      const budgetNum = numeric(ans.budget);
      const isApproved = String(ans.approved).toLowerCase()==='yes';

      const scored = STOCK.map(x=>({x,score:scoreLead(ans,x)}));
      const STRICT = scored.filter(m => (m.x.price||Infinity) <= budgetNum).sort(sortStrictByCloseness(budgetNum));
      const NEAR   = scored.filter(m => (m.x.price||Infinity) >  budgetNum && (m.x.price-budgetNum)/Math.max(1,budgetNum) <= 0.08).sort(sortNearByCloseness(budgetNum));

      let chosen = STRICT.slice(0,wantCount);
      if(chosen.length<wantCount && allowOver) chosen = chosen.concat(NEAR.slice(0,wantCount-chosen.length));
      if(chosen.length===0 && scored.length){
        chosen = scored.slice().sort((a,b)=>{
          const da=Math.abs((a.x.price||0)-budgetNum), db=Math.abs((b.x.price||0)-budgetNum);
          if(da!==db) return da-db; return b.score-a.score;
        }).slice(0,Math.min(wantCount,scored.length));
      }

      const out = document.getElementById('out');
      if(!chosen.length){
        out.innerHTML = `<p>No matches yet. Try adjusting budget/bedrooms.</p>`;
        document.getElementById('verifyCard').classList.add('hidden');
        return;
      }

      const items = chosen.map(m=>(
        `<li class="no-select">
          <a href="${m.x.url}" target="_blank" rel="noopener">${m.x.title}</a>
          <span class="muted"> (WebRef ${m.x.ref||'—'}) — ${fmtRand(m.x.price)} — Beds: ${bedsLbl(m.x.beds)} — ${m.x.area||''}</span>
        </li>`
      )).join('');
      const msg = isApproved
        ? '<p><strong>Nice!</strong> You’re pre-approved — let’s book a viewing. Pick a time and Blessing will confirm.</p>'
        : '<p><strong>Tip:</strong> Not pre-approved? We can connect you to a bond originator for a quick check.</p>';

      out.innerHTML = `<ol class="no-select">${items}</ol>${msg}`;

      // Build buyer message + show verify/send
      buildBuyerBaseSummary(ans, chosen);
      document.getElementById('verifyCard').classList.remove('hidden');
      updateAnchors(); // reflect current summary in WA/mail
    }

    /* ======================
       VIEW SWITCHING
       ====================== */
    function showBuyer(){
      document.getElementById('buyerPrefs').classList.remove('hidden');
      document.getElementById('buyerResults').classList.remove('hidden');
      document.getElementById('sellerCard').classList.add('hidden');
      document.getElementById('verifyCard').classList.add('hidden'); // shown after buyer clicks Show Matches
    }
    function showSeller(){
      document.getElementById('buyerPrefs').classList.add('hidden');
      document.getElementById('buyerResults').classList.add('hidden');
      document.getElementById('sellerCard').classList.remove('hidden');
      document.getElementById('verifyCard').classList.remove('hidden'); // seller can verify immediately
      newCode(); toggleSendButtons(false); updateAnchors();
      document.getElementById('helper').textContent = 'Fill a valid email, SA mobile, and type the code to unlock sending.';
    }

    /* ======================
       MAIN
       ====================== */
    (async function(){
      const STOCK = await loadStock();
      let pending = null; // stores buyer answers until verified

      // Role listeners
      document.getElementById('roleBuyer').addEventListener('change', e=>{ if(e.target.checked) showBuyer(); });
      document.getElementById('roleSeller').addEventListener('change', e=>{ if(e.target.checked) showSeller(); });
      showBuyer(); // default

      // Code regen
      document.getElementById('regen').addEventListener('click', newCode);
      newCode();

      // Live verify + link updates + auto-run if pending
      const onVerifyInputs = ()=>{
        const ok = isVerified();
        toggleSendButtons(ok);
        updateAnchors();
        document.getElementById('helper').textContent = ok
          ? 'Verified. You can send via WhatsApp or Email.'
          : 'Fill a valid email, SA mobile, and type the code to unlock sending.';
        if (ok && pending){
          computeAndRenderMatches(STOCK, pending);
          pending = null;
        }
      };
      ['input','change','keyup'].forEach(evt=>{
        ['#name','#email','#phone','#consent','#cta','#chk'].forEach(sel=>{
          document.querySelector(sel).addEventListener(evt, onVerifyInputs);
        });
      });

      // Buyer submit (strict lead gate before showing matches)
      document.getElementById('qform').addEventListener('submit', (e)=>{
        e.preventDefault();

        // Bot trap
        if ((document.getElementById('hp').value||'').trim() !== '') {
          alert('Submission blocked.');
          return;
        }

        const ans = Object.fromEntries(new FormData(e.target).entries());
        if (!numeric(ans.budget)) {
          alert('Please enter your budget (numbers only).');
          document.getElementById('budget').focus();
          return;
        }

        // If verified → render now; else remember, show verify card, auto-render after verify
        const ok = isVerified();
        if (!ok) {
          document.getElementById('verifyCard').classList.remove('hidden');
          document.getElementById('helper').textContent = 'Verify your email, SA mobile, and code to see your matches.';
          document.getElementById('chk').focus();
          pending = ans;
          toggleSendButtons(false);
          updateAnchors();
          return;
        }
        pending = null;
        computeAndRenderMatches(STOCK, ans);
      });
    })();
  </script>

  <!--
    🧱 SCALABILITY & MAINTENANCE (kid-friendly reminders)
    - Change agent phone/email: edit AGENT_PHONE_E164 / AGENT_EMAIL above.
    - New agent? Copy this file, swap phone/email + point to their /data/listings.json.
    - Stock stays fresh: a GitHub Action runs nightly to rewrite /data/listings.json.
    - Want stronger anti-bot? Swap code challenge for Cloudflare Turnstile (drop-in).
    - Want CRM sync? Point the WhatsApp/Email text to a Zapier/Power Automate webhook.
    - Keep page fast: it’s vanilla JS + tiny CSS; no heavy frameworks needed.
    - Test both roles (buyer/seller) on phone + desktop after each change.
  -->
</body>
</html>
