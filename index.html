<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Huizemark • Smart Match (Blessing Nsibande)</title>

  <!-- SEO essentials -->
  <link rel="canonical" href="https://match.ncdigital.co.za/">
  <meta name="description" content="Answer 5 quick questions and instantly see 2–10 Huizemark property matches. Book a viewing with Blessing Nsibande.">
  <meta property="og:title" content="Huizemark Smart Match — Quick Property Matches">
  <meta property="og:description" content="Get tailored Huizemark matches in seconds and book a viewing with Blessing.">
  <meta property="og:url" content="https://match.ncdigital.co.za/">
  <meta property="og:image" content="https://match.ncdigital.co.za/assets/og-image.jpg">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Brand theme (light default) -->
  <style>
    :root{
      --hz-orange:#f58220; --hz-grey:#4d4d4d; --hz-bg:#ffffff; --hz-text:#222;
      --hz-muted:#6b7280; --hz-border:#e5e7eb; --focus:#1d4ed8; --btn-text:#fff;
      --card-bg:#ffffff;
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --hz-bg:#0b0b0c; --hz-text:#eaeaea; --hz-muted:#9aa0a6; --hz-border:#2a2a2d;
        --card-bg:#141416;
      }
    }
    .theme-dark{
      --hz-bg:#0b0b0c; --hz-text:#eaeaea; --hz-muted:#9aa0a6; --hz-border:#2a2a2d;
      --card-bg:#141416;
    }

    /* Base */
    html:focus-within { scroll-behavior: smooth; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;
          background:var(--hz-bg); color:var(--hz-text); }
    a{ color:var(--hz-orange); }

    /* Skip link */
    .skip-link{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
    .skip-link:focus{ left:8px; top:8px; width:auto; height:auto; padding:10px 12px; background:#111; color:#fff; border-radius:8px; z-index:9999; }

    /* Layout */
    .wrap{ max-width: 780px; margin: 24px auto; padding: 0 16px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand__logo{ height: 64px; }

    .card{
      background:var(--card-bg); border:1px solid var(--hz-border);
      border-radius:12px; padding:20px; margin-top:16px;
    }
    .toolbar{ margin-left:auto; display:flex; align-items:center; gap:10px; }

    /* Forms */
    label{ display:block; margin:10px 0 4px; font-weight:600; }
    input, select, button, textarea { font: inherit; }
    input, select, textarea {
      width:100%; padding:12px; border:1px solid var(--hz-border); border-radius:10px;
      background:transparent; color:var(--hz-text);
    }
    input:focus, select:focus, button:focus, a:focus { outline: 3px solid var(--focus); outline-offset: 2px; }

    /* Buttons */
    .btn{ background:var(--hz-orange); color:var(--btn-text); border:0; border-radius:10px;
          padding:12px 16px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .btn.secondary{ background:var(--hz-grey); }

    /* Grid */
    .row{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 640px){ .row{ grid-template-columns:1fr; } }

    .muted{ color:var(--hz-muted); font-size: 0.95rem; }
    .results ol{ padding-left: 1.2rem; }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <header class="wrap" role="banner">
    <div class="brand" aria-label="Huizemark Smart Match header">
      <img class="brand__logo"
           src="https://d21tw07c6rnmp0.cloudfront.net/media/uploads/94/theme-settings/2025/5/94_8a5e0d54687d41228f79c92853b42629.png"
           alt="Huizemark logo" loading="lazy" decoding="async" />
      <h1 style="margin:0">Smart Match</h1>
      <div class="toolbar" role="group" aria-label="Theme toggle">
        <button id="toggleTheme" class="btn secondary" type="button" aria-pressed="false" aria-label="Toggle dark mode">🌙 Dark mode</button>
      </div>
    </div>
  </header>

  <main id="main" class="wrap" role="main">
    <section class="card" aria-labelledby="intro-title">
      <h2 id="intro-title" style="margin-top:0">Find matching Huizemark properties fast</h2>
      <p class="muted">We respect your privacy and POPIA. We’ll ask consent first.</p>
    </section>

    <section class="card" aria-labelledby="consent-title">
      <h2 id="consent-title" style="margin-top:0">Consent</h2>
      <p class="muted">
        By continuing, you consent to Huizemark storing your details for property matching only.
        Type <strong>STOP</strong> any time to opt out.
      </p>
    </section>

    <!-- PREFERENCES -->
    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title" style="margin-top:0">Your preferences</h2>
      <form id="qform" aria-describedby="form-help" novalidate>
        <p id="form-help" class="sr-only">Answer the fields, then press the Show Matches button.</p>

        <div class="row">
          <div>
            <label for="budget">Max budget (R)</label>
            <input id="budget" name="budget" inputmode="numeric" autocomplete="off" required placeholder="e.g. 1200000" aria-required="true" />
          </div>
          <div>
            <label for="beds">Bedrooms</label>
            <select id="beds" name="beds" aria-label="Number of bedrooms">
              <option>2</option><option selected>3</option><option>4</option><option>5+</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="schools">Schools</label>
            <select id="schools" name="schools" aria-label="Proximity to schools">
              <option>Walk</option><option selected>Short drive</option><option>Not important</option>
            </select>
          </div>
          <div>
            <label for="garden">Garden</label>
            <select id="garden" name="garden" aria-label="Garden preference">
              <option selected>Sunny</option><option>Shaded</option><option>Doesn’t matter</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="approved">Bond pre-approved?</label>
            <select id="approved" name="approved" aria-label="Bond pre-approval">
              <option>Yes</option><option selected>No</option>
            </select>
          </div>
          <div>
            <label for="count">How many matches to show?</label>
            <select id="count" name="count" aria-label="Number of results">
              <option>1</option>
              <option selected>3</option>
              <option>5</option>
              <option>10</option>
            </select>
            <div style="margin-top:6px">
              <label>
                <input type="checkbox" id="allowOverBudget" name="allowOverBudget">
                Show a few great picks slightly above my budget (if close)
              </label>
            </div>
          </div>
        </div>

        <div role="group" aria-label="Actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" type="submit">Show Matches</button>
          <a id="whatsappTop" class="btn" href="https://wa.me/27662729016?text=Hi%20Blessing,%20please%20match%20me" target="_blank" rel="noopener" role="button" aria-label="Chat with Blessing on WhatsApp">WhatsApp Blessing</a>
          <a id="emailTop" class="btn secondary" href="mailto:blessing@huizemark.co.za?subject=Smart Match Lead" role="button" aria-label="Email Blessing">Email Blessing</a>
        </div>
      </form>
    </section>

    <!-- RESULTS -->
    <section class="card results" aria-labelledby="results-title">
      <h2 id="results-title" style="margin-top:0">Top Matches</h2>
      <div id="out" aria-live="polite" aria-atomic="false">
        <p class="muted">Complete the form to see suggested properties.</p>
      </div>
    </section>

    <!-- LEAD FORM -->
    <section class="card" aria-labelledby="lead-title">
      <h2 id="lead-title" style="margin-top:0">Send to Blessing</h2>
      <form id="lead" style="display:none" novalidate>
        <div class="row">
          <div>
            <label for="name">Your name</label>
            <input id="name" name="name" autocomplete="name" required aria-required="true" />
          </div>
          <div>
            <label for="email">Your email</label>
            <input id="email" name="email" type="email" autocomplete="email" required aria-required="true" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="phone">Your phone (WhatsApp)</label>
            <input id="phone" name="phone" inputmode="tel" autocomplete="tel" required aria-required="true" />
          </div>
          <div>
            <label for="consent">Consent</label>
            <select id="consent" name="consent" aria-label="Consent to store details" required>
              <option value="YES" selected>YES (store for matching)</option>
              <option>NO</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label for="cta">What would you like to do next?</label>
            <select id="cta" name="cta" aria-label="Next step">
              <option selected>Arrange a viewing</option>
              <option>Request more photos/videos</option>
              <option>Get bond pre-approval help</option>
              <option>Call me back</option>
            </select>
          </div>
          <div id="ctaDetailsWrap">
            <label for="ctaDetails">Preferred time / details</label>
            <input id="ctaDetails" name="ctaDetails" placeholder="e.g. Sat 11:00–12:00, or any weekday after 5pm">
          </div>
        </div>

        <div role="group" aria-label="Contact actions" style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <a id="wa" class="btn" target="_blank" rel="noopener" role="button" aria-label="Chat with Blessing on WhatsApp">Chat on WhatsApp</a>
          <a id="mailto" class="btn secondary" role="button" aria-label="Email Blessing">Email Blessing</a>
          <button id="submitLead" class="btn" type="submit">Send details</button>
        </div>

        <p id="status" class="muted" role="status" aria-live="polite" style="margin-top:8px"></p>
      </form>
      <p class="muted" style="margin-top:12px">
        All results link back to <a href="https://www.huizemark.com/agents/blessing-nsibande/75570/" target="_blank" rel="noopener">Blessing’s Huizemark profile</a>.
      </p>
    </section>
  </main>

  <footer class="wrap" role="contentinfo" style="margin-bottom:24px;">
    <div class="card" aria-label="Quick contact">
      <div style="display:flex; flex-wrap:wrap; gap:10px;">
        <a class="btn" href="https://wa.me/27662729016?text=Hi%20Blessing,%20please%20match%20me" target="_blank" rel="noopener">WhatsApp Blessing</a>
        <a class="btn secondary" href="mailto:blessing@huizemark.co.za?subject=Smart Match Lead">Email Blessing</a>
      </div>
    </div>
  </footer>

  <!-- JSON-LD for RealEstateAgent -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"RealEstateAgent",
    "name":"Huizemark — Blessing Nsibande",
    "url":"https://match.ncdigital.co.za/",
    "logo":"https://match.ncdigital.co.za/assets/huizemark-logo.png",
    "image":"https://match.ncdigital.co.za/assets/og-image.jpg",
    "areaServed":["Brakpan","Benoni","Ekurhuleni"],
    "telephone":"+27-66-272-9016",
    "sameAs":["https://www.huizemark.com/agents/blessing-nsibande/75570/"]
  }
  </script>

  <!-- App logic -->
  <script>
    /* ========= Dark mode toggle (persisted) ========= */
    (function(){
      const btn = document.getElementById('toggleTheme');
      const saved = localStorage.getItem('sm-theme'); // 'dark' | 'light' | null
      if(saved === 'dark') document.documentElement.classList.add('theme-dark');
      if(saved === 'light') document.documentElement.classList.remove('theme-dark');

      function updateLabel(){
        const isDark = document.documentElement.classList.contains('theme-dark');
        btn.setAttribute('aria-pressed', String(isDark));
        btn.textContent = isDark ? '☀️ Light mode' : '🌙 Dark mode';
      }
      updateLabel();

      btn.addEventListener('click', ()=>{
        document.documentElement.classList.toggle('theme-dark');
        const isDark = document.documentElement.classList.contains('theme-dark');
        localStorage.setItem('sm-theme', isDark ? 'dark' : 'light');
        updateLabel();
      });
      btn.addEventListener('keydown', (e)=>{ if(e.code === 'Space'){ e.preventDefault(); btn.click(); } });
    })();

    /* ========= Data source =========
       If hosting on GitHub Pages under same domain:
       Use a relative path to avoid CORS issues.
    */
    const STOCK_URL = '/data/listings.json';

    // Optional built-in fallback to avoid "no matches"
    window.FALLBACK_STOCK = [];

    async function loadStock(){
      try{
        const r = await fetch(STOCK_URL, {cache: 'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.json();
      }catch(e){
        console.warn('Could not fetch live stock, using fallback', e);
        return window.FALLBACK_STOCK || [];
      }
    }

    /* ========= Helpers ========= */
    function fmtRand(n){ try{ return 'R' + Number(n||0).toLocaleString('en-ZA'); }catch(_){ return 'R' + (n||0); } }
    function bedsLabel(v){ return (v==null || v===undefined) ? 'N/A' : String(v); }
    function joinBlocks(blocks){ return blocks.filter(Boolean).join('\n\n'); }
    function numeric(val){ return parseInt(String(val||"").replace(/\D/g,"")||"0",10); }

    function scoreLead(ans,x){
      let s=0;
      // soft scoring (we still enforce budget separately)
      const budget = numeric(ans.budget);
      if(budget >= (x.price||Infinity)) s+=15;
      const wanted = parseInt(String(ans.beds||"2").replace("+","")||"2",10);
      if(wanted <= (x.beds||0)) s+=10;
      if(ans.schools===x.schools) s+=10;   // only if you store schools in JSON
      if(ans.garden===x.garden) s+=5;      // only if you store garden in JSON
      if(String(ans.approved).toLowerCase()==="yes") s+=60;
      return s;
    }

    /* ========= Main ========= */
    (async function(){
      const qform = document.getElementById('qform');
      const out   = document.getElementById('out');
      const lead  = document.getElementById('lead');
      const statusEl = document.getElementById('status');
      const waTop = document.getElementById('whatsappTop');
      const mailTop = document.getElementById('emailTop');
      const waBtn = document.getElementById('wa');
      const mailBtn = document.getElementById('mailto');

      const STOCK = await loadStock();

      // Base summary text holder (without personal details)
      let baseSummary = "";

      qform.addEventListener('submit', (e)=>{
        e.preventDefault();
        const ans = Object.fromEntries(new FormData(qform).entries());
        const wantCount = Math.max(1, parseInt(ans.count || '3', 10));
        const allowOver = !!document.getElementById('allowOverBudget')?.checked;

        const scored = STOCK.map(x => ({ x, score: scoreLead(ans, x) }));

        // Strict budget first
        const budgetNum = numeric(ans.budget);
        const STRICT = scored.filter(m => (m.x.price||Infinity) <= budgetNum);
        // Near budget within +8%
        const NEAR = scored.filter(m => (m.x.price||Infinity) > budgetNum && (m.x.price - budgetNum)/Math.max(1,budgetNum) <= 0.08);

        STRICT.sort((a,b)=>b.score-a.score);
        NEAR.sort((a,b)=>b.score-a.score);

        let chosen = STRICT.slice(0, wantCount);
        if (chosen.length < wantCount && allowOver) {
          chosen = chosen.concat(NEAR.slice(0, wantCount - chosen.length));
        }
        if (chosen.length === 0 && scored.length) {
          chosen = scored.sort((a,b)=>b.score-a.score).slice(0, Math.min(wantCount, scored.length));
        }

        const listHtml = chosen.map(m => (
          `<li>
             <a href="${m.x.url}" target="_blank" rel="noopener">${m.x.title}</a>
             <span class="muted"> (WebRef ${m.x.ref || '—'}) — ${fmtRand(m.x.price)} — Beds: ${bedsLabel(m.x.beds)} — ${m.x.area || ''}</span>
           </li>`
        )).join("");

        out.innerHTML = chosen.length
          ? `<ol>${listHtml}</ol>${
              (Math.max(...chosen.map(m=>m.score))>=80
                ? '<p><strong>Hot lead:</strong> Would you like a viewing? Choose a time and we’ll confirm with Blessing.</p>'
                : '<p><strong>Tip:</strong> Not pre-approved? We can connect you to a bond originator for a quick check.</p>')}`
          : `<p>No matches yet. Try adjusting budget/bedrooms. You can also message Blessing directly below.</p>`;

        const matchesBlocks = chosen.map(m => {
          const lines = [
            `• ${m.x.title}`,
            `  WebRef: ${m.x.ref || '—'}`,
            `  Price: ${fmtRand(m.x.price)}`,
            `  Beds: ${bedsLabel(m.x.beds)}`,
            `  Area: ${m.x.area || ''}`,
            `  Link: ${m.x.url}`
          ];
          return lines.join('\n');
        });

        baseSummary = joinBlocks([
          `Hi Blessing, please see my Smart Match results:`,
          `Budget: ${fmtRand(budgetNum)}`,
          `Beds wanted: ${ans.beds}`,
          `Schools: ${ans.schools}`,
          `Garden: ${ans.garden}`,
          `Pre-approved: ${ans.approved}`,
          ``,
          `Matches:`,
          ...matchesBlocks
        ]);

        // Prefill quick-contact buttons (user can send immediately)
        waTop.href = `https://wa.me/27662729016?text=${encodeURIComponent(baseSummary)}`;
        mailTop.href = `mailto:blessing@huizemark.co.za?subject=Smart Match Lead&body=${encodeURIComponent(baseSummary)}`;

        // Reveal lead form
        lead.style.display = 'block';
        lead.setAttribute('tabindex','-1'); lead.focus();
        statusEl.textContent = "";
      });

      // Lead submit: append buyer details + CTA
      lead.addEventListener('submit', (e)=>{
        e.preventDefault();
        const data = Object.fromEntries(new FormData(lead).entries());

        if (String(data.consent).toUpperCase() !== 'YES'){
          statusEl.textContent = "We need consent to send your details.";
          return;
        }
        if (data.cta === 'Get bond pre-approval help' && !data.ctaDetails) {
          data.ctaDetails = 'Please refer me to a bond originator for a quick check.';
        }

        const full = joinBlocks([
          baseSummary,
          `---`,
          `BUYER DETAILS`,
          `Name: ${data.name}`,
          `Email: ${data.email}`,
          `Phone: ${data.phone}`,
          `Next step: ${data.cta}`,
          data.ctaDetails ? `Details: ${data.ctaDetails}` : ''
        ]);

        waBtn.href   = `https://wa.me/27662729016?text=${encodeURIComponent(full)}`;
        mailBtn.href = `mailto:blessing@huizemark.co.za?subject=Smart Match Lead&body=${encodeURIComponent(full)}`;
        // Also update top buttons now that we have details
        document.getElementById('whatsappTop').href =
          `https://wa.me/27662729016?text=${encodeURIComponent(full)}`;
        document.getElementById('emailTop').href =
          `mailto:blessing@huizemark.co.za?subject=Smart Match Lead&body=${encodeURIComponent(full)}`;

        statusEl.textContent = "Thanks! Your message is ready — tap WhatsApp or Email.";
        // Auto-open WhatsApp? Uncomment:
        // window.location.href = waBtn.href;
      });

      // Accessibility: let Enter/Space activate top anchor-buttons
      for (const el of [document.getElementById('whatsappTop'), document.getElementById('emailTop')]) {
        el.setAttribute('tabindex','0');
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); el.click(); } });
      }
    })();
  </script>
</body>
</html>
