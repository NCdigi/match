<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Huizemark • Smart Match (Blessing Nsibande)</title>
  <style>
    :root{--hz-orange:#f58220; --hz-grey:#4d4d4d; --hz-bg:#fff; --hz-text:#222; --hz-muted:#6b7280; --hz-border:#e5e7eb; --btn-text:#fff; --card-bg:#fff;}
    .theme-dark{--hz-bg:#0b0b0c; --hz-text:#eaeaea; --hz-muted:#9aa0a6; --hz-border:#2a2a2d; --card-bg:#141416;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:var(--hz-bg);color:var(--hz-text)}
    a{color:var(--hz-orange)} .wrap{max-width:780px;margin:24px auto;padding:0 16px}
    .card{background:var(--card-bg);border:1px solid var(--hz-border);border-radius:12px;padding:20px;margin-top:16px}
    .brand{display:flex;align-items:center;gap:12px}.brand img{height:64px}
    label{display:block;margin:10px 0 4px;font-weight:600}
    input,select,button,textarea{font:inherit} input,select,textarea{width:100%;padding:12px;border:1px solid var(--hz-border);border-radius:10px;background:transparent;color:var(--hz-text)}
    .btn{background:var(--hz-orange);color:var(--btn-text);border:0;border-radius:10px;padding:12px 16px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
    .btn.secondary{background:#4d4d4d} .row{display:grid;gap:12px;grid-template-columns:1fr 1fr} @media(max-width:640px){.row{grid-template-columns:1fr}}
    .muted{color:var(--hz-muted)} .results ol{padding-left:1.2rem}
    .toolbar{margin-left:auto} .quick{display:none;margin-top:12px;border-top:1px solid var(--hz-border);padding-top:12px}
  </style>
</head>
<body>
  <header class="wrap">
    <div class="brand">
      <img src="https://d21tw07c6rnmp0.cloudfront.net/media/uploads/94/theme-settings/2025/5/94_8a5e0d54687d41228f79c92853b42629.png" alt="Huizemark" />
      <h1 style="margin:0">Smart Match</h1>
      <div class="toolbar">
        <button id="toggleTheme" class="btn secondary" type="button">🌙 Dark mode</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2 style="margin-top:0">Your preferences</h2>
      <form id="qform" novalidate>
        <div class="row">
          <div>
            <label for="budget">Max budget (R)</label>
            <input id="budget" name="budget" inputmode="numeric" required placeholder="e.g. 1200000" />
          </div>
          <div>
            <label for="beds">Bedrooms</label>
            <select id="beds" name="beds"><option>2</option><option selected>3</option><option>4</option><option>5+</option></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="approved">Bond pre-approved?</label>
            <select id="approved" name="approved"><option>Yes</option><option selected>No</option></select>
          </div>
          <div>
            <label for="count">How many matches?</label>
            <select id="count" name="count"><option>1</option><option selected>3</option><option>5</option><option>10</option></select>
            <div style="margin-top:6px">
              <label><input type="checkbox" id="allowOverBudget"> Include a few slightly above budget (≤ 8%)</label>
            </div>
          </div>
        </div>
        <button class="btn" type="submit">Show Matches</button>
      </form>
    </section>

    <section class="card results">
      <h2 style="margin-top:0">Top Matches</h2>
      <div id="out" class="muted">Complete the form to see suggested properties.</div>

      <!-- ONE contact area (DRY): updates WhatsApp/Email live -->
      <div id="quick" class="quick">
        <h3 style="margin:8px 0">Quick contact</h3>
        <div class="row">
          <div><label for="name">Your name</label><input id="name" autocomplete="name" placeholder="e.g. Thabo M."></div>
          <div><label for="email">Your email</label><input id="email" type="email" autocomplete="email" placeholder="you@example.com"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <div><label for="phone">Your phone (WhatsApp)</label><input id="phone" inputmode="tel" autocomplete="tel" placeholder="+27 82 123 4567"></div>
          <div>
            <label for="cta">What next?</label>
            <select id="cta"><option selected>Arrange a viewing</option><option>Request more photos/videos</option><option>Get bond pre-approval help</option><option>Call me back</option></select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div><label for="cta_details">Preferred time / details</label><input id="cta_details" placeholder="e.g. Sat 11:00–12:00"></div>
          <div style="display:flex;align-items:center">
            <label><input type="checkbox" id="consent"> I consent to Huizemark storing my details (POPIA)</label>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button id="btnWA" class="btn" type="button">Chat on WhatsApp</button>
          <button id="btnEmail" class="btn secondary" type="button">Email Blessing</button>
        </div>
        <p class="muted" id="helper" style="margin:6px 0 0"></p>
      </div>
    </section>
  </main>

  <script>
    /* ======= THEME (force class, persisted) ======= */
    (function(){
      const root = document.documentElement, btn = document.getElementById('toggleTheme');
      const saved = localStorage.getItem('sm-theme');
      if(saved==='dark') root.classList.add('theme-dark');
      function label(){ btn.textContent = root.classList.contains('theme-dark') ? '☀️ Light mode' : '🌙 Dark mode'; }
      label();
      btn.addEventListener('click', ()=>{ root.classList.toggle('theme-dark'); localStorage.setItem('sm-theme', root.classList.contains('theme-dark')?'dark':'light'); label(); });
    })();

    /* ======= DATA ======= */
    const STOCK_URL = '/data/listings.json';
    async function loadStock(){ try{ const r = await fetch(STOCK_URL,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json(); }catch(_){ return []; } }

    /* ======= HELPERS ======= */
    const $ = sel => document.querySelector(sel);
    const fmtRand = n => 'R' + Number(n||0).toLocaleString('en-ZA');
    const bedsLabel = v => (v==null? 'N/A' : String(v));
    const numeric = v => parseInt(String(v||'').replace(/\D/g,'' )||'0',10);
    const joinBlocks = arr => arr.filter(Boolean).join('\n\n');

    function scoreLead(ans,x){
      let s=0;
      if(numeric(ans.budget) >= (x.price||Infinity)) s+=15;
      const want = parseInt(String(ans.beds||'2').replace('+','')||'2',10);
      if(want <= (x.beds||0)) s+=10;
      if(String(ans.approved).toLowerCase()==='yes') s+=60;
      return s;
    }
    const sortStrictByCloseness = (budget)=>(a,b)=>{
      const da = budget - (a.x.price||0), db = budget - (b.x.price||0);
      if(da!==db) return da-db; if((b.x.price||0)!==(a.x.price||0)) return (b.x.price||0)-(a.x.price||0);
      return b.score-a.score;
    };
    const sortNearByCloseness = (budget)=>(a,b)=>{
      const da = (a.x.price||Infinity)-budget, db = (b.x.price||Infinity)-budget;
      if(da!==db) return da-db; if((b.x.price||0)!==(a.x.price||0)) return (b.x.price||0)-(a.x.price||0);
      return b.score-a.score;
    };

    /* ======= MESSAGE BUILDERS ======= */
    let baseSummary = '';      // preferences + matches
    let fullSummary = '';      // base + PII / CTA (if consent)

    function buildBaseSummary(ans, chosen){
      const budgetNum = numeric(ans.budget);
      const blocks = chosen.map(m => [
        `• ${m.x.title}`,
        `  WebRef: ${m.x.ref||'—'}`,
        `  Price: ${fmtRand(m.x.price)}`,
        `  Beds: ${bedsLabel(m.x.beds)}`,
        `  Area: ${m.x.area||''}`,
        `  Link: ${m.x.url}`
      ].join('\n'));
      baseSummary = joinBlocks([
        `Hi Blessing, please see my Smart Match results:`,
        `Budget: ${fmtRand(budgetNum)}`,
        `Beds wanted: ${ans.beds}`,
        `Pre-approved: ${ans.approved}`,
        ``,
        `Matches:`,
        ...blocks
      ]);
    }

    function buildFullSummaryFromUI(){
      const wantsPII = $('#consent').checked;
      const parts = [baseSummary, '---'];
      if(wantsPII){
        const nm = $('#name').value.trim(), em = $('#email').value.trim(), ph = $('#phone').value.trim();
        parts.push('BUYER DETAILS');
        if(nm) parts.push(`Name: ${nm}`);
        if(em) parts.push(`Email: ${em}`);
        if(ph) parts.push(`Phone: ${ph}`);
      }
      const cta = $('#cta').value;
      let det = $('#cta_details').value.trim();
      if(cta==='Get bond pre-approval help' && !det) det = 'Please refer me to a bond originator for a quick check.';
      parts.push(`Next step: ${cta}`);
      if(det) parts.push(`Details: ${det}`);
      fullSummary = joinBlocks(parts);
    }

    /* ======= OPENERS (WhatsApp + Email) ======= */
    function openWhatsApp(text){
      // 1) Try native app first
      const native = `whatsapp://send?text=${encodeURIComponent(text)}`;
      const web    = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`; // better x-browser than wa.me
      let opened = false;

      // Use an iframe trick for iOS/Safari; else try location change
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      if(isIOS){
        const iframe = document.createElement('iframe');
        iframe.style.display='none'; iframe.src=native;
        document.body.appendChild(iframe);
      }else{
        window.location.href = native;
      }

      const start = Date.now();
      setTimeout(()=>{
        // If still here after ~800ms, fall back to web link
        if(Date.now()-start < 1800 && !opened){
          window.location.href = web;
        }
      }, 800);
    }

    function openEmail(text){
      const url = `mailto:blessing@huizemark.co.za?subject=${encodeURIComponent('Smart Match Lead')}&body=${encodeURIComponent(text)}`;
      window.location.href = url;
    }

    /* ======= MAIN ======= */
    (async function(){
      const STOCK = await loadStock();
      const out = $('#out'), quick = $('#quick');
      const helper = $('#helper');

      // Live update links as user types
      ['input','change'].forEach(evt=>{
        ['#name','#email','#phone','#consent','#cta','#cta_details'].forEach(sel=>{
          document.querySelector(sel).addEventListener(evt, ()=>{
            buildFullSummaryFromUI();
            helper.textContent = $('#consent').checked ? 'Your details will be sent with the results.' : 'Results will be sent without your personal details (no consent).';
          });
        });
      });

      // Buttons
      $('#btnWA').addEventListener('click', ()=>{
        buildFullSummaryFromUI();
        openWhatsApp(fullSummary || baseSummary);
      });
      $('#btnEmail').addEventListener('click', ()=>{
        buildFullSummaryFromUI();
        openEmail(fullSummary || baseSummary);
      });

      // Match flow
      $('#qform').addEventListener('submit', (e)=>{
        e.preventDefault();
        const ans = Object.fromEntries(new FormData(e.target).entries());
        const wantCount = Math.max(1, parseInt(ans.count||'3',10));
        const allowOver = !!document.getElementById('allowOverBudget').checked;
        const budgetNum = numeric(ans.budget);
        const isApproved = String(ans.approved).toLowerCase()==='yes';

        const scored = STOCK.map(x=>({x,score:scoreLead(ans,x)}));
        const STRICT = scored.filter(m => (m.x.price||Infinity) <= budgetNum).sort(sortStrictByCloseness(budgetNum));
        const NEAR   = scored.filter(m => (m.x.price||Infinity) >  budgetNum && (m.x.price-budgetNum)/Math.max(1,budgetNum) <= 0.08).sort(sortNearByCloseness(budgetNum));

        let chosen = STRICT.slice(0,wantCount);
        if(chosen.length<wantCount && allowOver) chosen = chosen.concat(NEAR.slice(0,wantCount-chosen.length));
        if(chosen.length===0 && scored.length){
          chosen = scored.slice().sort((a,b)=>{
            const da=Math.abs((a.x.price||0)-budgetNum), db=Math.abs((b.x.price||0)-budgetNum);
            if(da!==db) return da-db; return b.score-a.score;
          }).slice(0,Math.min(wantCount,scored.length));
        }

        // Render results
        if(!chosen.length){
          out.innerHTML = `<p>No matches yet. Try adjusting budget/bedrooms.</p>`;
          quick.style.display='none';
          return;
        }
        const items = chosen.map(m=>(
          `<li>
            <a href="${m.x.url}" target="_blank" rel="noopener">${m.x.title}</a>
            <span class="muted"> (WebRef ${m.x.ref||'—'}) — ${fmtRand(m.x.price)} — Beds: ${bedsLabel(m.x.beds)} — ${m.x.area||''}</span>
          </li>`
        )).join('');
        const msg = isApproved
          ? '<p><strong>Nice!</strong> You’re pre-approved — let’s book a viewing. Pick a time and Blessing will confirm.</p>'
          : '<p><strong>Tip:</strong> Not pre-approved? We can connect you to a bond originator for a quick check.</p>';
        out.innerHTML = `<ol>${items}</ol>${msg}`;

        // Build base summary + show quick contact
        buildBaseSummary(ans, chosen);
        quick.style.display='block';
        helper.textContent = $('#consent').checked ? 'Your details will be sent with the results.' : 'Results will be sent without your personal details (no consent).';
      });
    })();
  </script>
</body>
</html>
